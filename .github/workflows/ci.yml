# =============================================================================
# .github/workflows/ci.yml - CI Pipeline
# =============================================================================
# Este workflow ejecuta en cada push y PR:
# - Linting (golangci-lint)
# - Tests
# - Security scanning (gosec, trivy)
# - Build
# =============================================================================

name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

env:
  GO_VERSION: '1.24.3'

# Permisos necesarios
permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  # ═══════════════════════════════════════════════════════════════
  # JOB 1: LINTING
  # ═══════════════════════════════════════════════════════════════
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m --config=.golangci.yml
          skip-cache: false
          skip-pkg-cache: false
          skip-build-cache: false
      
      - name: Check go.mod is tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

  # ═══════════════════════════════════════════════════════════════
  # JOB 2: SECURITY SCANNING
  # ═══════════════════════════════════════════════════════════════
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      # Gosec - Security scanner
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'
      
      - name: Upload Gosec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
      
      # Nancy - Dependency vulnerability scanner
      - name: Install Nancy
        run: go install github.com/sonatype-nexus-community/nancy@latest
      
      - name: Run Nancy dependency scanner
        run: go list -json -deps ./... | nancy sleuth
        continue-on-error: true

  # ═══════════════════════════════════════════════════════════════
  # JOB 3: TESTS
  # ═══════════════════════════════════════════════════════════════
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Run tests
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Generate coverage report
        run: |
          go tool cover -html=coverage.out -o coverage.html
      
      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.html

  # ═══════════════════════════════════════════════════════════════
  # JOB 4: BUILD
  # ═══════════════════════════════════════════════════════════════
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Build
        run: |
          go build -v -o bin/orchestrator ./cmd/server/main.go
      
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-binary
          path: bin/orchestrator
          retention-days: 7

  # ═══════════════════════════════════════════════════════════════
  # JOB 5: DOCKER BUILD & SCAN
  # ═══════════════════════════════════════════════════════════════
  docker:
    name: Build and Scan Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: smartbin-orchestrator:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      # Trivy - Container vulnerability scanner
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: smartbin-orchestrator:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
      
      - name: Run Trivy in table format
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: smartbin-orchestrator:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  # ═══════════════════════════════════════════════════════════════
  # JOB 6: CODE QUALITY
  # ═══════════════════════════════════════════════════════════════
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para SonarQube
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      # SonarQube/SonarCloud (opcional - requiere configuración)
      # - name: SonarQube Scan
      #   uses: sonarsource/sonarqube-scan-action@master
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      
      # CodeQL Analysis (opcional - para análisis de código profundo)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: go
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ═══════════════════════════════════════════════════════════════
  # JOB 7: SUMMARY
  # ═══════════════════════════════════════════════════════════════
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, security, test, build, docker, quality]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail if any job failed
        if: |
          needs.lint.result == 'failure' ||
          needs.security.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.docker.result == 'failure' ||
          needs.quality.result == 'failure'
        run: exit 1